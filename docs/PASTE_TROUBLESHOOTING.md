# ペースト機能のトラブルシューティング

## ✅ 修正済み - ピッチ位置指定の問題

**問題**: ペースト時に選択した位置にタイミングは合うが、ピッチ（音程）がずれて下の方にペーストされる

**修正**: クリップボードシステムを更新し、ピッチ位置も正しく処理するようになりました

## 🔍 現在の実装

以下の優先順位でペースト位置（タイミングとピッチ）が決まります：

1. **Shift+クリック で指定したペースト位置** (tick + pitch)
2. **Ctrl+クリック で選択したグリッドセル** (tick + pitch)
3. **選択中の音符の位置** (tick + pitch)
4. **デフォルト位置 (tick 0, 元のピッチ)**

## 🐛 デバッグ手順

アプリケーションを起動して以下の手順でテストしてください：

### 1. 基本的なテスト
```
1. ノート入力モードで音符を作成
2. 選択モードに切り替え（Tab または 2）
3. 音符を選択してCtrl+Cでコピー
4. 空のセルでShift+クリック（ペースト位置指定）
5. Ctrl+Vでペースト
```

### 2. デバッグ情報の確認
ペースト時に以下の情報がコンソールに出力されます：
```
DEBUG: Paste target cell: GridCell(start_tick=XXX, end_tick=XXX, pitch=XX)
DEBUG: Selected cells count: X
DEBUG: Selected notes count: X
DEBUG: Using paste target cell at tick XXX
DEBUG: Quantized target tick: XXX
DEBUG: Successfully pasted X notes at tick XXX
```

### 3. グリッドセル選択のテスト
```
1. 選択モードでCtrl+クリック（グリッドセル選択）
2. 複数のセルを選択
3. Ctrl+Vでペースト
4. 最初のセルの位置にペーストされることを確認
```

## 🔧 よくある問題と解決方法

### 問題1: 選択した位置にペーストされない
**原因**: 選択状態がクリアされている
**解決**: 
- 選択モードでShift+クリックしてペースト位置を明示的に指定
- Ctrl+クリックでグリッドセルを選択した後すぐにCtrl+V

### 問題2: 元の位置にペーストされる
**原因**: 選択中の音符が優先されている
**解決**: 
- 音符の選択を解除してからグリッドセルを選択
- Shift+クリックでペースト位置を明示的に指定

### 問題3: デバッグ情報が表示されない
**原因**: コンソールが確認できない
**解決**: 
- ターミナルからアプリケーションを起動
- `python -m src.main` または `python run_app.py`

## 📋 正しい使用手順

### A. Shift+クリックでペースト位置指定
```
1. 選択モードに切り替え
2. 音符を選択してCtrl+C
3. ペーストしたい位置でShift+クリック
4. Ctrl+Vでペースト
```

### B. グリッドセル選択でペースト
```
1. 選択モードに切り替え
2. 音符を選択してCtrl+C
3. 音符の選択を解除（空の場所をクリック）
4. Ctrl+クリックでグリッドセルを選択
5. Ctrl+Vでペースト
```

### C. 複数セル選択でペースト
```
1. 選択モードに切り替え
2. 音符を選択してCtrl+C
3. 複数のセルをCtrl+クリックで選択
4. Ctrl+Vでペースト（最初のセルの位置に）
```

## 🔍 詳細なデバッグ

もし問題が続く場合は、以下の手順でデバッグ情報を確認してください：

1. アプリケーションをターミナルから起動
2. ペースト操作を行う
3. コンソールに出力される以下の情報を確認：
   - `DEBUG: Paste target cell:` - ペースト位置指定の状態
   - `DEBUG: Selected cells count:` - 選択中のグリッドセル数
   - `DEBUG: Selected notes count:` - 選択中の音符数
   - `DEBUG: Using XXX` - 実際に使用されるペースト位置
   - `DEBUG: Successfully pasted X notes at tick XXX` - ペースト結果

## 🎯 期待される動作

- **Shift+クリック**: オレンジ色のセルが表示され、そこにペースト
- **Ctrl+クリック**: 青色のセルが表示され、最初のセルにペースト
- **音符選択**: 選択中の音符の位置にペースト
- **何も選択なし**: tick 0にペースト