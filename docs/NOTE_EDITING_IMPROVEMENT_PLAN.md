# ノート編集機能改善計画

## 概要
DominoPyのピアノロールにおけるノート編集機能の改善計画。より直感的で柔軟なノート編集体験を提供することを目標とする。

## 現在の問題点

### 1. 複数ノート選択時のリサイズ問題
- **現状**: 複数ノートを選択してリサイズすると、全てのノートが同じ比率で一気に伸縮
- **問題**: 操作が直感的でなく、細かい調整が困難
- **期待**: ドラッグしたノートのみを変更し、選択状態は維持

### 2. グリッドスナップの制限
- **現状**: 常時16分音符単位（120 ticks）に自動量子化
- **問題**: 任意の長さでノートを配置・調整できない
- **期待**: 必要に応じてフリーフォームでの編集が可能

## 改善計画

### Phase 1: グリッドスナップ制御機能
**目標**: 柔軟な量子化制御の実装

#### 実装内容
1. **動的スナップ制御**
   - Alt/Optionキー押下時：グリッドスナップ無効
   - 修飾キーによるリアルタイム制御

2. **量子化設定の拡張**
   - 設定パネルでの量子化ON/OFF切り替え
   - 量子化単位の動的変更（全音符〜64分音符）
   - ユーザー設定の保存・復元

3. **視覚的フィードバック**
   - グリッドスナップ状態の表示
   - フリーモード時のカーソル変更

#### 変更ファイル
- `src/ui/piano_roll_widget.py`: スナップ制御ロジック
- `src/grid_system.py`: GridManagerの拡張
- 設定関連: 新しい設定項目追加

### Phase 2: 複数ノート編集の改善
**目標**: 直感的な複数ノート操作の実現

#### 実装内容
1. **リサイズモードの実装**
   - **デフォルト**: ドラッグしたノートのみリサイズ
   - **Shift + ドラッグ**: 選択された全ノートを比例リサイズ
   - **選択状態維持**: リサイズ後も複数選択を保持

2. **視覚的プレビュー**
   - リサイズ中のゴーストノート表示
   - 操作対象ノートのハイライト
   - リアルタイム長さ表示

3. **操作の改善**
   - マウスホイールでの微調整
   - 数値入力による精密調整
   - キーボードショートカットの追加

#### 新しいクラス設計
```python
class NoteEditingController:
    """ノート編集の専用コントローラー"""
    - handle_single_note_resize()
    - handle_proportional_resize()
    - maintain_selection_state()

class GridSnapManager:
    """グリッドスナップの状態管理"""
    - is_snap_enabled()
    - get_snap_resolution()
    - apply_modifier_keys()
```

### Phase 3: 精密編集機能
**目標**: プロフェッショナルレベルの編集精度

#### 実装内容
1. **精密編集モード**
   - ズームレベル連動の編集精度
   - ピクセル単位での微調整
   - 高精度タイムライン表示

2. **数値編集機能**
   - ノート長の直接入力
   - 開始位置の精密指定
   - バッチ編集機能

3. **高度な選択機能**
   - 条件による自動選択
   - ノート長での絞り込み
   - 音程範囲での選択

## 操作性の改善

### キーボード修飾キー
- **Alt/Option + ドラッグ**: フリーリサイズ（スナップ無効）
- **Shift + ドラッグ**: 比例リサイズ（全選択ノート）
- **Ctrl/Cmd + ドラッグ**: 複製しながらリサイズ

### マウス操作
- **ホイール**: 微調整（±1 tick）
- **Shift + ホイール**: 粗調整（±量子化単位）
- **右クリック**: コンテキストメニュー

### 視覚的改善
- **カーソル変更**: 操作モードの明確化
- **ハイライト**: アクティブノートの表示
- **プレビュー**: 操作結果の事前表示

## 技術的実装方針

### アーキテクチャ
1. **責任の分離**
   - UIロジック vs ビジネスロジック
   - 編集操作の専用コントローラー
   - 状態管理の集約

2. **拡張性の確保**
   - プラグイン可能な編集モード
   - 設定システムの柔軟性
   - 将来機能への対応

3. **パフォーマンス**
   - 大量ノート選択時の最適化
   - リアルタイム描画の効率化
   - メモリ使用量の最適化

### コード品質
1. **テストカバレッジ**
   - 単体テストの追加
   - 統合テストの実装
   - ユーザビリティテスト

2. **エラーハンドリング**
   - 境界条件の安全性
   - ユーザー操作の検証
   - 復旧可能なエラー処理

## スケジュール

### Phase 1 (1-2週間) ✅ **完了**
- ✅ グリッドスナップ制御の実装
- ✅ Alt/Optionキー対応（フリーリサイズ）
- ✅ 複数ノート編集の改善（単一リサイズ・比例リサイズ）
- ✅ Shiftキーによるリサイズモード切り替え

### Phase 2 (2-3週間)  
- 複数ノート編集の改善
- 新しいリサイズモード
- 視覚的フィードバック

### Phase 3 (1-2週間)
- 精密編集機能
- 数値入力機能
- 最終調整・テスト

## 成功指標

### 機能面
- [x] Alt/Optionキーでのフリーリサイズ
- [x] 複数選択時の直感的リサイズ（比例リサイズ）
- [x] 単一選択時の個別ノート編集
- [ ] 量子化単位の動的変更

### ユーザビリティ
- [ ] 直感的な操作感
- [ ] 作業効率の向上
- [ ] 学習コストの低減
- [ ] プロフェッショナルワークフローのサポート

### 技術面
- [ ] パフォーマンスの維持・向上
- [ ] コードの保守性向上
- [ ] 拡張性の確保
- [ ] テストカバレッジの向上

---

**最終更新**: 2025-07-23  
**次回更新予定**: Phase 1完了時