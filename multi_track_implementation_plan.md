# Multi-Track Support Implementation Plan

## 🎯 目標
現在の1トラック固定状態から、最大16トラックをサポートするマルチトラックシーケンサーに拡張

## 📊 現在のアーキテクチャ分析

### ✅ 既に対応済み
- **MidiDataModel**: 既にマルチトラック対応 (`MidiProject.tracks: List[MidiTrack]`)
- **MidiNote**: channel属性あり (0-15)
- **PlaybackEngine**: 全トラックからノートを収集して再生
- **AudioSystem**: チャンネル別再生対応

### 🔧 実装が必要な領域

#### 1. UI Components (優先度: 高)
- **トラックリスト**: 左側にトラック一覧表示
- **トラック選択**: アクティブトラックの概念
- **トラック設定**: 名前、楽器、音量、ミュート、ソロ
- **ピアノロール統合**: 選択されたトラックのみ編集

#### 2. 編集システム (優先度: 高)
- **トラック別ノート管理**: アクティブトラックへのノート追加
- **トラック間コピー/移動**: ノートの複製・移動
- **アンドゥ/リドゥ**: トラック操作の履歴管理

#### 3. 表示システム (優先度: 高) ⭐ **MANDATORY**
- **色分け表示**: トラック別の視覚的区別 **[MUST HAVE]**
- **重複表示**: 複数トラックの同時表示オプション
- **フォーカス管理**: アクティブトラックの強調

#### 4. 再生・音声システム (優先度: 中)
- **チャンネル管理**: 各トラックの独立MIDI チャンネル
- **楽器設定**: トラック別プログラムチェンジ
- **ミックス機能**: トラック別音量・パン

## 🏗️ 実装フェーズ

### Phase 1: Core Infrastructure (1-2日)
1. **TrackManager クラス**
   - アクティブトラック管理
   - トラック追加/削除/複製
   - トラック設定管理

2. **UI Foundation**
   - トラックリストウィジェット基本構造
   - トラック選択UI
   - ピアノロールとの連携

### Phase 2: Basic Multi-Track Editing + Color System (2-3日)
1. **トラック色分けシステム** ⭐ **MUST HAVE** (最優先)
   - 各トラック専用カラーパレット (16色セット)
   - ノート表示での色反映
   - トラックリストでの色表示・選択UI
   - 色の保存・復元

2. **ピアノロール拡張**
   - アクティブトラックのみ編集
   - トラック切り替え時の表示更新
   - ノート追加時のトラック指定
   - **色分けノート表示の統合**

3. **トラック設定UI**
   - 名前変更
   - **カラー選択** (高優先度)
   - 楽器選択 (Basic)
   - ミュート/ソロ

### Phase 3: Advanced Features (2-3日)
1. **視覚的拡張**
   - 複数トラック同時表示 (色分け済み)
   - アクティブトラック強調
   - 色コントラスト・アクセシビリティ対応

2. **編集機能拡張**
   - トラック間ノートコピー/移動
   - トラック全体の操作 (複製/削除)

### Phase 4: Polish & Optimization (1-2日)
1. **パフォーマンス最適化**
   - 大量ノート表示の最適化
   - 描画パフォーマンス改善

2. **ユーザビリティ改善**
   - キーボードショートカット
   - 右クリックメニュー
   - ドラッグ&ドロップ

## 🎵 技術的考慮事項

### トラック数の制限
- **推奨: 16トラック** (MIDI標準の16チャンネルに対応)
- **UI制限**: スクロール可能なトラックリストで対応
- **パフォーマンス**: 各トラック1000-5000ノートまで快適動作想定

### メモリ使用量
- **1トラック**: ~1MB (1000ノート想定)
- **16トラック**: ~16MB (十分実用的)

### 描画パフォーマンス
- **現在**: 単一トラック最適化
- **目標**: 16トラック同時表示 60FPS維持
- **手法**: ビューポート外ノートの描画スキップ

## 🎨 UI設計方針

### レイアウト
```
[Menu Bar]
[Toolbar - Mode/Playback Controls]
[Music Info Toolbar]
┌─────────────┬─────────────────────────────────┐
│Track List   │Piano Roll + Scrollbars         │
│🟥 Track 1 ♪ │                                 │
│🟦 Track 2 ♫ │     [Colored Notes Area]        │
│🟩 Track 3   │                                 │
│+ Add Track  │                                 │
└─────────────┴─────────────────────────────────┘
[Status Bar]
```

### トラックリスト仕様
- **幅**: 200px (固定 or リサイズ可能)
- **高さ**: トラック1つあたり40-50px
- **情報**: **色インジケーター**, 名前, 楽器, ミュート, ソロ, 音量
- **操作**: クリック選択, **色選択**, 右クリックメニュー

### 色分けシステム仕様 ⭐ **MANDATORY**
- **パレット**: 16色の専用カラーセット (視認性重視)
- **表示**: ノート, トラックリスト, 選択UI全てで統一
- **選択**: カラーピッカーまたは プリセットパレット
- **保存**: プロジェクトファイルに色情報保存

## 🚀 実装開始点
1. `TrackManager`クラスの実装
2. 基本的なトラックリストUI
3. ピアノロールのトラック連携

## ⚠️ リスク要因
1. **UI複雑性**: トラック管理UIの使いやすさ
2. **パフォーマンス**: 大量データでの描画速度
3. **互換性**: 既存の単一トラックプロジェクトとの互換性

## 📝 成功指標
- 16トラック同時再生で音声遅延なし
- トラック切り替えが瞬時 (<100ms)
- 直感的なトラック操作UI
- 既存機能の完全保持